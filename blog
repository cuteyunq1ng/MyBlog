#!/bin/bash

# 配置区域 - 根据你的实际情况修改
BLOG_ROOT="$HOME/Public/myblog/"  # 修改为你的博客根目录路径
POSTS_DIR="$HOME/Myblog"
MAIN_BRANCH="main"  # 或 master，根据你的仓库设置

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 功能函数
new_post() {
    if [ -z "$1" ]; then
        echo -e "${RED}错误：请提供文章标题${NC}"
        echo "用法: blog new '文章标题'"
        return 1
    fi
    
    echo -e "${BLUE}创建新文章: $1${NC}"
    cd "$BLOG_ROOT"
    hexo new post "$1"
    
    # 显示创建的文件路径
    local new_file=$(find source/_posts -name "*$1*" -type f | head -1)
    if [ -n "$new_file" ]; then
        echo -e "${GREEN}文章已创建: $new_file${NC}"
        echo -e "${GREEN}你可以在 ~/my_blog_posts/ 目录中找到它${NC}"
    fi
}

blog_status() {
    echo -e "${BLUE}检查博客状态...${NC}"
    cd "$BLOG_ROOT"
    
    echo -e "\n${YELLOW}=== Git 状态 ===${NC}"
    git status
    
    echo -e "\n${YELLOW}=== 最近提交 ===${NC}"
    git log --oneline -5
    
    echo -e "\n${YELLOW}=== 文章统计 ===${NC}"
    echo "文章总数: $(find source/_posts -name "*.md" | wc -l)"
    echo "最新文章: $(find source/_posts -name "*.md" -exec ls -lt {} + | head -1 | awk '{print $9}')"
}

blog_sync() {
    if [ -z "$1" ]; then
        echo -e "${RED}错误：请提供提交信息${NC}"
        echo "用法: blog sync '提交信息描述'"
        return 1
    fi
    
    echo -e "${BLUE}同步博客到远程仓库...${NC}"
    cd "$BLOG_ROOT"
    
    # 检查是否有更改
    if git diff-index --quiet HEAD --; then
        echo -e "${YELLOW}没有检测到更改${NC}"
        return 0
    fi
    
    # 执行 Git 操作
    echo -e "${YELLOW}添加更改...${NC}"
    git add .
    
    echo -e "${YELLOW}提交更改...${NC}"
    git commit -m "$1"
    
    echo -e "${YELLOW}推送到远程仓库...${NC}"
    if git push myblogongithub "$MAIN_BRANCH"; then
        echo -e "${GREEN}✅ 同步成功！GitHub Actions 将自动部署你的博客${NC}"
        echo -e "${GREEN}📝 提交信息: $1${NC}"
    else
        echo -e "${RED}❌ 推送失败，请检查网络连接或权限设置${NC}"
        return 1
    fi
}

# 查看文章目录
cd_posts() {
    cd "$POSTS_DIR"
    echo -e "${GREEN}文章列表: $(pwd)${NC}"
    ls -la
}
test() {
    cd "$BLOG_ROOT"
    hexo clean && hexo s -g
}

# 显示帮助信息
show_help() {
    echo -e "${BLUE}博客管理助手 - 简化你的写作工作流${NC}"
    echo ""
    echo -e "${GREEN}可用命令:${NC}"
    echo "  blog new '文章标题'   - 创建新文章"
    echo "  blog status           - 检查博客状态"
    echo "  blog sync '提交信息'  - 提交并同步到远程仓库"
    echo "  blog posts            - 列出当前文章目录"
    echo "  blog test             - 快速进行本地测试"
    echo "  blog help             - 显示此帮助信息"
    echo ""
    echo -e "${YELLOW}工作流示例:${NC}"
    echo "  1. blog new '我的新文章'     # 创建文章"
    echo "  2. 编辑 ~/my_blog_posts/我的新文章.md"
    echo "  3. blog test '本地查看文章'    # 提交发布"
    echo "  4. blog sync '添加新文章'    # 提交发布"
}

# 主命令解析
case "$1" in
    "new")
        new_post "$2"
        ;;
    "status")
        blog_status
        ;;
    "sync")
        blog_sync "$2"
        ;;
    "posts")
        cd_posts
        ;;
    "help"|"")
        show_help
        ;;
    "test")
        test
        ;;
    *)
        echo -e "${RED}未知命令: $1${NC}"
        show_help
        ;;
esac
